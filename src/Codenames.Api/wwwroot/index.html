<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Codenames</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
 body { font-family: system-ui, Arial, sans-serif; margin: 1rem; background:#f3f4f6; color:#111; }
 .top-bar { display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:.5rem; }
 .top-bar h1 { margin:0; font-size:1.4rem; }
 .top-right { display:flex; flex-direction:column; align-items:flex-end; gap:.25rem; }
 .spymaster-toggle { display:flex; align-items:center; gap:.35rem; }
 .game-id { font-size:.75rem; color:#6b7280; }
 .controls { display:flex; gap:1rem; align-items:center; flex-wrap:wrap; margin-bottom:.5rem; }
 button { cursor:pointer; padding:.5rem .9rem; background:#2563eb; border:none; color:#fff; border-radius:4px; font-weight:600; }
 button.secondary { background:#2563eb; }
 button:disabled { opacity:.5; cursor:not-allowed; }
 input, select { padding:.45rem .5rem; border-radius:4px; border:1px solid #9ca3af; background:#6b7280; color:#fff; }
 .panel { margin-top:1rem; display:flex; gap:2rem; flex-wrap:wrap; }
 .col { min-width:220px; }
 .submit-clue-form { display:flex; flex-direction:column; align-items:flex-start; gap:.55rem; }
 .submit-clue-form label { display:flex; flex-direction:column; font-size:.8rem; font-weight:600; gap:.25rem; }
 .submit-clue-form button { margin-top:.9rem; }
 .counts span { display:inline-block; margin-right:1rem; }
 .game-stats { border:2px solid #9ca3af; border-radius:8px; padding:1rem; background:#fff; }
 .boards-wrapper { display:flex; gap:3rem; align-items:flex-start; margin-top:1.25rem; }
 .board-column { min-width: 430px; }
 .board-column h3 { margin:.2rem 0 .4rem; font-size:1rem; letter-spacing:.5px; font-weight:600; }
 .board { display:grid; grid-template-columns:repeat(5, 1fr); gap:.6rem; max-width:880px; background:#d1d5db; padding:.75rem; border-radius:12px; }
 .card { aspect-ratio: 1.45/1; border-radius:8px; display:flex; align-items:center; justify-content:center; padding:.35rem; text-align:center; font-size:.75rem; font-weight:600; letter-spacing:.5px; position:relative; user-select:none; transition:background .25s, transform .15s; }
 .card:hover { transform:translateY(-2px); }
 .card.revealed { filter:brightness(1.15); }
 /* High-contrast vivid team colors for both boards */
 .type-RedAgent { background:#dc2626; color:#f5f7fa; }
 .type-BlueAgent { background:#2563eb; color:#f5f7fa; }
 .type-Neutral { background:#a3a3a3; color:#f5f7fa; }
 .type-Assassin { background:#000; color:#f5f7fa; box-shadow:0 0 0 2px #fff inset; }
 .covered { background:#2d3642; }

 /* Base card styles for both boards */
 .card { color:#f5f7fa; }

 /* Spymaster board - same look as operatives board */
 #spymasterBoard { background:#d1d5db; border-radius:12px; }

 .winner { font-size:1.2rem; font-weight:700; color:#fcd34d; }
 .log { max-width:880px; margin-top:1.2rem; background:#1e2530; padding:1rem; border-radius:8px; font-size:.8rem; color:#f5f7fa; }
 .log h3 { margin:0 0 .75rem 0; font-size:1rem; color:#f5f7fa; }
 .clue-columns { display:flex; gap:2rem; }
 .clue-column { flex:1; }
 .clue-column h4 { margin:0 0 .5rem 0; font-size:.85rem; font-weight:600; }
 .clue-column.red h4 { color:#dc2626; }
 .clue-column.blue h4 { color:#60a5fa; }
 .clue { margin-bottom:.25rem; }
 .correct-flash { animation: flash 0.8s ease; }
 @keyframes flash { 0% { box-shadow:0 0 0 0 rgba(255,255,255,.9);} 100% { box-shadow:0 0 0 12px rgba(255,255,255,0);} }
 #spymasterBoardPlaceholder { opacity:.6; font-size:.85rem; padding:.75rem; background:#d1d5db; border:1px dashed #475569; border-radius:12px; width:100%; display:flex; align-items:center; justify-content:center; box-sizing:border-box; }
</style>
</head>
<body>
<div class="top-bar">
  <h1>Codenames</h1>
  <div class="top-right">
    <label class="spymaster-toggle" title="Show roles (right side)">
      <input type="checkbox" id="spymasterChk" /> Spymaster
    </label>
    <div class="game-id" id="gameIdDisplay"></div>
  </div>
</div>
<div class="controls">
  <label>Start Team
    <select id="startTeam">
      <option value="Red">Red</option>
      <option value="Blue">Blue</option>
    </select>
  </label>
  <label>Seed <input id="seed" type="number" placeholder="(optional)"/></label>
  <button id="newGameBtn">New Game</button>
</div>
<div class="panel">
  <div class="col">
    <h3>Submit Clue</h3>
    <div class="submit-clue-form">
      <label>Team
        <select id="clueTeam"></select>
      </label>
      <label>Clue
        <input id="clueText"/>
      </label>
      <label>Count
        <input id="clueCount" type="number" min="0" value="1"/>
      </label>
      <button id="submitClueBtn" disabled>Submit Clue</button>
    </div>
  </div>
  <div class="col counts">
    <h3>Game Stats</h3>
    <div class="game-stats">
      <div><span>Red Remaining: <strong id="redCount">-</strong></span><span>Blue Remaining: <strong id="blueCount">-</strong></span></div>
      <div>Phase: <span id="phase">-</span></div>
      <div>Current Team: <span id="currentTeam">-</span></div>
      <div>Current Clue: <span id="currentClue">-</span></div>
      <div>Guesses: <span id="guessProgress">-</span></div>
      <div class="winner" id="winner"></div>
    </div>
    <button id="endTurnBtn" class="secondary" disabled style="margin-top:.6rem;">End Turn</button>
  </div>
</div>
<div class="boards-wrapper">
  <div class="board-column">
    <h3>Operatives Board</h3>
    <div class="board" id="board"></div>
  </div>
  <div class="board-column">
    <h3>Spymaster Board</h3>
    <div id="spymasterBoardPlaceholder">Toggle Spymaster to view full colored roles here.</div>
    <div class="board" id="spymasterBoard" style="display:none;"></div>
  </div>
</div>
<div class="log" id="clueLog"></div>
<script>
let gameId = null;
let currentTeam = null;
const boardEl = document.getElementById('board');
const spymasterBoardEl = document.getElementById('spymasterBoard');
const spymasterPlaceholder = document.getElementById('spymasterBoardPlaceholder');
const newBtn = document.getElementById('newGameBtn');
const startTeamEl = document.getElementById('startTeam');
const seedEl = document.getElementById('seed');
const clueTeamEl = document.getElementById('clueTeam');
const clueTextEl = document.getElementById('clueText');
const clueCountEl = document.getElementById('clueCount');
const submitClueBtn = document.getElementById('submitClueBtn');
const redCountEl = document.getElementById('redCount');
const blueCountEl = document.getElementById('blueCount');
const phaseEl = document.getElementById('phase');
const currentTeamEl = document.getElementById('currentTeam');
const currentClueEl = document.getElementById('currentClue');
const guessProgressEl = document.getElementById('guessProgress');
const winnerEl = document.getElementById('winner');
const endTurnBtn = document.getElementById('endTurnBtn');
const clueLogEl = document.getElementById('clueLog');
const gameIdDisplay = document.getElementById('gameIdDisplay');
const spymasterChk = document.getElementById('spymasterChk');

// Initialize clue team dropdown with options
clueTeamEl.innerHTML = `<option value="Red">Red</option><option value="Blue">Blue</option>`;
clueTeamEl.value = startTeamEl.value;

async function createGame(){
const body = { StartingTeam: startTeamEl.value };
if(seedEl.value) body.Seed = parseInt(seedEl.value,10);
const res = await fetch('/games', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)});
if(!res.ok){ alert('Create failed'); return; }
  const data = await res.json();
  gameId = data.game.gameId;
  gameIdDisplay.textContent = 'Game: ' + gameId;
  clueTeamEl.value = startTeamEl.value;
  await refreshOperatives();
  await refreshSpymaster();
}

async function refreshOperatives(){
  if(!gameId) return;
  const res = await fetch(`/games/${gameId}`); // non-spymaster
  if(!res.ok) return;
  const state = await res.json();
  renderOperatives(state);
}

async function refreshSpymaster(){
  if(!gameId) return;
  if(!spymasterChk.checked){
    spymasterBoardEl.style.display='none';
    spymasterPlaceholder.style.display='flex';
    spymasterBoardEl.innerHTML='';
    return;
  }
  const res = await fetch(`/games/${gameId}?spymaster=true`);
  if(!res.ok) return;
  const state = await res.json();
  renderSpymaster(state);
}

function renderOperatives(state){
currentTeam = state.currentTeam; // Track current team for guessing
redCountEl.textContent = state.redAgentsRemaining;
blueCountEl.textContent = state.blueAgentsRemaining;
phaseEl.textContent = state.phase;
currentTeamEl.textContent = state.currentTeam;
winnerEl.textContent = state.winner ? `Winner: ${state.winner}` : '';

// Show current clue only during guessing phase, clear it when awaiting new clue
if(state.phase === 'AwaitingGuesses' && state.clues.length > 0){
  const latestClue = state.clues[state.clues.length-1];
  currentClueEl.textContent = `${latestClue.text} (${latestClue.declaredCount})`;
  guessProgressEl.textContent = state.currentClueGuesses != null ? `${state.currentClueGuesses}/${state.currentClueMaxGuesses}` : '-';
} else {
  currentClueEl.textContent = '-';
  guessProgressEl.textContent = '-';
}

submitClueBtn.disabled = !(state.phase === 'AwaitingClue');
endTurnBtn.disabled = !(state.phase === 'AwaitingGuesses' && !state.winner);

// Sync clue team dropdown with current team when it's time to submit a clue
if(state.phase === 'AwaitingClue'){
  clueTeamEl.value = state.currentTeam;
}

boardEl.innerHTML='';
  state.board.forEach(card => {
    const div = document.createElement('div');
    const classes = ['card'];
    if(card.revealed){ classes.push('revealed','type-'+card.type); }
    else { classes.push('covered'); }
    div.className = classes.join(' ');
    div.textContent = card.word; // words visible; only color after reveal
    if(state.phase==='AwaitingGuesses' && !card.revealed && !state.winner){
      div.style.cursor='pointer';
      div.onclick = () => makeGuess(card.position, div, state.currentTeam);
    }
    boardEl.appendChild(div);
  });

  // Render clue history in two columns by team
  const redClues = state.clues.filter(c => c.team === 'Red');
  const blueClues = state.clues.filter(c => c.team === 'Blue');
  clueLogEl.innerHTML = `
    <h3>Clues History</h3>
    <div class="clue-columns">
      <div class="clue-column red">
        <h4>Red Team</h4>
        ${redClues.length ? redClues.map(c => `<div class="clue"><em>${c.text}</em> (${c.declaredCount})</div>`).join('') : '<div class="clue">-</div>'}
      </div>
      <div class="clue-column blue">
        <h4>Blue Team</h4>
        ${blueClues.length ? blueClues.map(c => `<div class="clue"><em>${c.text}</em> (${c.declaredCount})</div>`).join('') : '<div class="clue">-</div>'}
      </div>
    </div>
  `;

  // Sync placeholder size with operatives board
  requestAnimationFrame(() => {
    spymasterPlaceholder.style.height = boardEl.offsetHeight + 'px';
    spymasterPlaceholder.style.width = boardEl.offsetWidth + 'px';
  });
}

async function endTurn(){
if(!gameId || !currentTeam) return;
const body = { Team: currentTeam };
const res = await fetch(`/games/${gameId}/endturn`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)});
  if(!res.ok){ alert('End turn error'); return; }
  await refreshOperatives();
  await refreshSpymaster();
}

function renderSpymaster(state){
  spymasterPlaceholder.style.display='none';
  spymasterBoardEl.style.display='grid';
  spymasterBoardEl.innerHTML='';
  state.board.forEach(card => {
    const div = document.createElement('div');
    div.className = 'card type-'+card.type + (card.revealed ? ' revealed' : '');
    // Show word only; styling makes Red/Blue/Neutral identical in spymaster view
    div.textContent = card.word;
    spymasterBoardEl.appendChild(div);
  });
}

async function submitClue(){
  if(!gameId) return;
  const body = { Team: clueTeamEl.value, Clue: clueTextEl.value, Count: parseInt(clueCountEl.value,10) };
  const res = await fetch(`/games/${gameId}/clues`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)});
  if(!res.ok){ 
    const err = await res.json().catch(() => null);
    alert('Error submitting clue: ' + (err?.error || res.statusText)); 
    return; 
  }
  clueTextEl.value='';
  clueCountEl.value='1';
  await refreshOperatives();
  await refreshSpymaster();
}

async function makeGuess(position, element, team){
const body = { Team: team, Position: position };
const res = await fetch(`/games/${gameId}/guesses`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)});
  if(!res.ok){ alert('Guess error'); return; }
  const result = await res.json();
  if(result.outcome === 'FriendlyAgent'){
    element.classList.remove('covered');
    element.classList.add('type-'+(team === 'Red' ? 'RedAgent' : 'BlueAgent'),'revealed','correct-flash');
  } else if(result.outcome === 'OpponentAgent') {
    element.classList.remove('covered');
    element.classList.add('revealed','type-'+ (team === 'Red' ? 'BlueAgent':'RedAgent'));
  } else if(result.outcome === 'Neutral') {
    element.classList.remove('covered');
    element.classList.add('revealed','type-Neutral');
  } else if(result.outcome === 'Assassin') {
    element.classList.remove('covered');
    element.classList.add('revealed','type-Assassin');
  }
  await Promise.all([refreshOperatives(), refreshSpymaster()]);
}

newBtn.onclick = createGame;
submitClueBtn.onclick = submitClue;
spymasterChk.onchange = () => { refreshSpymaster(); };
endTurnBtn.onclick = endTurn;

// Sync clue team dropdown when start team is changed (before game starts)
startTeamEl.onchange = () => {
  if(!gameId || clueTeamEl.options.length === 0) return;
  clueTeamEl.value = startTeamEl.value;
  currentTeamEl.textContent = startTeamEl.value;
};

createGame();
setInterval(()=>{ refreshOperatives(); refreshSpymaster(); }, 4000);
</script>
</body>
</html>